{% extends "base_layout.html" %}

{% block title %}
Book Details - {{ isbn }}
{% endblock %}

{% block content %}
<div>
    <h1 id="book-title" class="text-2xl font-bold text-center mb-4">Loading...</h1>
    <div class="container mx-auto">
        <!-- Book Details Section -->
        <h3 class="text-xl font-semibold mb-4">Details</h3>
        <div id="book-details-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg mb-6">
                <thead>
                    <tr>
                        <th class="px-6 py-4 border-b text-center">Author</th>
                        <th class="px-6 py-4 border-b text-center">Genre</th>
                        <th class="px-6 py-4 border-b text-center">Publication Date</th>
                        <th class="px-6 py-4 border-b text-center">ISBN</th>
                    </tr>
                </thead>
                <tbody id="book-details">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Book Description Section -->
        <h3 class="text-xl font-semibold mb-4">Description</h3>
        <div id="book-description-section">
            <div id="book-description" class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                Loading...
            </div>
        </div>

        <!-- Reviews Section -->
        <h3 class="text-xl font-semibold mb-4">Reviews</h3>
        <div id="reviews-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg">
                <thead>
                    <tr>
                        <th class="px-6 py-3 border-b text-center">Reviewer</th>
                        <th class="px-6 py-3 border-b text-center">Review</th>
                        <th class="px-6 py-3 border-b text-center">Reviewed at</th>
                    </tr>
                </thead>
                <tbody id="reviews-table-body">
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", async function () {
        const isbn = "{{ isbn }}";
        const userRole = "{{ role }}";

        // Fetch and display book details
        try {
            const detailsResponse = await fetch(`/books/${isbn}/details`);
            if (detailsResponse.ok) {
                const book = await detailsResponse.json();
                document.getElementById("book-details").innerHTML = `
                    <tr>
                        <td class="px-6 py-4 border-b text-center">${book.author}</td>
                        <td class="px-6 py-4 border-b text-center">${book.genre}</td>
                        <td class="px-6 py-4 border-b text-center">${book.publicationDate}</td>
                        <td class="px-6 py-4 border-b text-center">${book.isbn}</td>
                    </tr>
                `;
                document.getElementById("book-description").textContent = book.description;
                document.getElementById("book-title").textContent = book.title;
            } else if (detailsResponse.status === 403) {
                document.getElementById("book-details-section").innerHTML = `
                    <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                        <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                            ${generatePermissionErrorMessage(userRole, "view", "book details")}
                        </div>
                    </div>
                `;
                document.getElementById("book-description-section").innerHTML = `
                    <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                        <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                            ${generatePermissionErrorMessage(userRole, "view", "book description")}
                        </div>
                    </div>
                `;
            } else {
                throw new Error("Failed to fetch book details.");
            }
        } catch (error) {
            console.error("Error fetching book details:", error);
            document.getElementById("book-details-section").innerHTML = `
                <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                    <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                        ${error.message}
                    </div>
                </div>
            `;
            document.getElementById("book-details-description").innerHTML = `
                <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                    <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                        ${error.message}
                    </div>
                </div>
            `;
        }

        // Fetch and display book reviews
        try {
            const reviewsResponse = await fetch(`/books/${isbn}/reviews`);
            if (reviewsResponse.ok) {
                const reviews = await reviewsResponse.json();
                const reviewsTableBody = document.getElementById("reviews-table-body");
                reviewsTableBody.innerHTML = "";
                reviews.forEach(review => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td class="px-6 py-4 border-b text-center">${review.reviewer}</td>
                        <td class="px-6 py-4 border-b text-center">${review.text}</td>
                        <td class="px-6 py-4 border-b text-center">${review.date}</td>
                    `;
                    reviewsTableBody.appendChild(row);
                });
            } else if (reviewsResponse.status === 403) {
                document.getElementById("reviews-section").innerHTML = `
                    <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                        <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                            ${generatePermissionErrorMessage(userRole, "view", "book reviews")}
                        </div>
                    </div>
                `;
            } else {
                throw new Error("Failed to fetch reviews.");
            }
        } catch (error) {
            console.error("Error fetching reviews:", error);
            document.getElementById("reviews-section").innerHTML = `
                <div class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                    <div class="bg-red-100 text-red-700 px-4 py-2 rounded-md">
                        ${error.message}
                    </div>
                </div>
            `;
        }
    });
</script>
{% endblock %}
