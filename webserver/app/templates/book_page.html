{% extends "base_layout.html" %}

{% block title %}
Book Details - {{ isbn }}
{% endblock %}

{% block content %}
<div>
    <h1 id="book-title" class="text-2xl font-bold text-center mb-4">{{ title }}</h1>
    <div id="book-rating" class="text-center text-sm mb-4"></div>
    
    <div class="container mx-auto">
        <button id="add-new-review-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-700 mb-4">Leave a review</button>
        <!-- Book Details Section -->
        <h3 class="text-xl font-semibold mb-4">Details</h3>
        <div id="book-details-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg mb-6">
                <thead>
                    <tr>
                        <th class="px-6 py-4 border-b text-center">Author</th>
                        <th class="px-6 py-4 border-b text-center">Genre</th>
                        <th class="px-6 py-4 border-b text-center">Publication Date</th>
                        <th class="px-6 py-4 border-b text-center">ISBN</th>
                    </tr>
                </thead>
                <tbody id="book-details">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Book Description Section -->
        <h3 class="text-xl font-semibold mb-4">Description</h3>
        <div id="book-description-section">
            <div id="book-description" class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                Loading...
            </div>
        </div>

        <!-- Reviews Section -->
        <h3 class="text-xl font-semibold mb-4">Reviews</h3>
        <div id="reviews-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg">
                <thead>
                    <tr>
                        <th class="px-6 py-3 border-b text-center">Reviewer</th>
                        <th class="px-6 py-3 border-b text-center">Review</th>
                        <th class="px-6 py-3 border-b text-center">Reviewed at</th>
                    </tr>
                </thead>
                <tbody id="reviews-table-body">
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal for Adding New Review -->
    <div id="add-review-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
        <div class="flex justify-center items-center w-full h-full">
            <div class="bg-white p-6 rounded-md shadow-lg max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Review for {{ title }}</h2>
                <form id="add-review-form">
                    <div class="mb-4">
                        <label for="review-text" class="block mb-2">Review</label>
                        <textarea 
                            id="review-text" 
                            name="reviewText" 
                            class="w-full p-2 border rounded" 
                            rows="5" 
                            placeholder="Write your review here..." 
                            required>
                        </textarea>
                    </div>
                    <div class="flex space-x-4">
                        <button 
                            type="button" 
                            id="cancel-btn" 
                            class="w-full bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            id="add-review-btn" 
                            class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Add Review
                        </button>
                    </div>                    
                </form>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", async function () {
        const isbn = "{{ isbn }}";
        const userRole = "{{ role }}";
        const rating = parseFloat("{{ rating }}");

        async function initEventListeners() {
            const addBookBtn = document.getElementById('add-new-review-btn');
            addBookBtn.addEventListener('click', openAddReviewModal);

            const cancelBtn = document.getElementById('cancel-btn');
            cancelBtn.addEventListener('click', closeAddReviewModal);

            const addBookForm = document.getElementById('add-review-form');
            addBookForm.addEventListener('submit', handleAddReview);
        }

        function openAddReviewModal() {
            const modal = document.getElementById("add-review-modal");
            modal.classList.remove("hidden");
        }

        function closeAddReviewModal() {
            document.getElementById("add-review-form").reset();
            const modal = document.getElementById("add-review-modal");
            modal.classList.add("hidden");
        }

        async function handleAddReview(event) {
            event.preventDefault();
            const text = document.getElementById('review-text').value;

            try {
                const response = await fetch(`/books/reviews/${isbn}`, {
                    method: 'POST',
                    body: JSON.stringify({ text }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 403) {
                    closeAddReviewModal();
                    displayErrorMessageWithWhiteBorderAndButtonModal(
                        generatePermissionErrorMessage(userRole, "add", "review"),
                        "close-btn",
                        "Close",
                    );
                }

                if (response.ok) {
                    closeAddReviewModal();
                    displaySuccessMessageWithWhiteBorderAndButtonModal(
                        "Sent review successfully!",
                        "close-btn",
                        "Ok",
                    );
                } else {
                    console.error("Failed to add book");
                }
            } catch (err) {
                console.error(err);
            }
        }

        // Fetch and render book details
        async function fetchAndRenderBookDetails() {
            try {
                const response = await fetch(`/books/details/${isbn}`);
                if (response.ok) {
                    const book = await response.json();
                    document.getElementById("book-details").innerHTML = `
                        <tr>
                            <td class="px-6 py-4 border-b text-center">${book.author}</td>
                            <td class="px-6 py-4 border-b text-center">${book.genre}</td>
                            <td class="px-6 py-4 border-b text-center">${book.publicationDate}</td>
                            <td class="px-6 py-4 border-b text-center">${book.isbn}</td>
                        </tr>
                    `;
                    document.getElementById("book-description").textContent = book.description;
                } else if (response.status === 403) {
                    displayErrorMessageWithWhiteBorder(
                        "book-details-section",
                        generatePermissionErrorMessage(userRole, "view", "book details")
                    );
                    displayErrorMessageWithWhiteBorder(
                        "book-description-section",
                        generatePermissionErrorMessage(userRole, "view", "book description")
                    );
                } else {
                    throw new Error("Failed to fetch book details.");
                }
            } catch (error) {
                console.error("Error fetching book details:", error);
                displayErrorMessage("book-details-section", error.message);
                displayErrorMessage("book-description-section", error.message);
            }
        }

        // Fetch and render book reviews
        async function fetchAndRenderBookReviews() {
            try {
                const response = await fetch(`/books/reviews/${isbn}`);
                if (response.ok) {
                    const reviews = await response.json();
                    const reviewsTableBody = document.getElementById("reviews-table-body");
                    reviewsTableBody.innerHTML = "";
                    const userRole = getUserRole();

                    reviews.forEach(review => {
                        const row = document.createElement("tr");
                        row.classList.add("cursor-pointer", "hover:bg-gray-100", "group");

                        const deleteButtonHTML = (userRole !== "guest" && userRole !== "user")
                            ? `
                                <button
                                    class="bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-700 hidden group-hover:block delete-review-btn"
                                    data-review-id="${review.reviewId}"
                                >
                                    Delete
                                </button>
                            `
                            : "";

                        row.innerHTML = `
                            <td class="px-6 py-4 border-b text-center">${review.reviewer}</td>
                            <td class="px-6 py-4 border-b text-center">${review.text}</td>
                            <td class="px-6 py-4 border-b text-center">${new Date(review.date).toISOString().replace('T', ' ').substring(0, 19)}</td>
                            <td class="px-6 py-4 border-b text-left w-16">
                                ${deleteButtonHTML}
                            </td>
                        `;

                        if (deleteButtonHTML) {
                            const deleteButton = row.querySelector(".delete-review-btn");

                            deleteButton.addEventListener("click", (event) => {
                                event.stopPropagation();
                                handleDeleteReview(review);
                            });

                            row.addEventListener("mouseover", () => {
                                deleteButton.classList.remove("hidden");
                            });

                            row.addEventListener("mouseout", () => {
                                deleteButton.classList.add("hidden");
                            });
                        }

                        reviewsTableBody.appendChild(row);
                    });
                } else if (response.status === 403) {
                    displayErrorMessageWithWhiteBorder(
                        "reviews-section",
                        generatePermissionErrorMessage(userRole, "view", "book reviews")
                    );
                } else {
                    throw new Error("Failed to fetch reviews.");
                }
            } catch (error) {
                console.error("Error fetching reviews:", error);
                displayErrorMessage("reviews-section", error.message);
            }
        }

        async function handleDeleteReview(review) {
            try {
                const reviewId = review.reviewId;
                const title = "review by " + review.reviewer;
                const response = await fetch(`/books/reviews/delete/${reviewId}`, {
                    method: "DELETE",
                });

                if (response.status === 403) {
                    displayErrorMessageWithWhiteBorderAndButtonModal(
                        generatePermissionErrorMessage(userRole, "delete", title),
                        "close-btn",
                        "Close",
                    );
                    return;
                }

                if (response.ok) {
                    displaySuccessMessageWithWhiteBorderAndButtonModal(
                        "Review deleted successfully!",
                        "close-btn",
                        "Ok",
                    );
                } else {
                    console.error("Error deleting review:", response.statusText);
                }
            } catch (error) {
                console.error("Error deleting review:", error);
            }
        }

        async function fetchAndRenderBookRating() {
            try {
                const response = await fetch(`/books/ratings/${isbn}`);
                if (response.ok) {
                    const ratingsData = await response.json();
                    const ratingElement = document.getElementById("book-rating");
                    const averageRating = calculateAverageRating(ratingsData);
                    if (averageRating < 0) {
                        displayErrorMessage(
                            "book-rating",
                            generatePermissionErrorMessage(userRole, "view", "book average rating")
                        );
                    } else {
                        const fullStars = Math.floor(averageRating);
                        const halfStar = averageRating - fullStars >= 0.5 ? 1 : 0;
                        const emptyStars = 5 - fullStars - halfStar;

                        ratingElement.innerHTML = `
                            ${'<span class="text-yellow-500">&#9733;</span>'.repeat(fullStars)}
                            ${halfStar ? '<span class="text-yellow-500">&#9734;</span>' : ''}
                            ${'<span class="text-gray-400">&#9734;</span>'.repeat(emptyStars)}
                            <span class="text-sm text-gray-500">${averageRating}/<span class="text-lg text-gray-500">5</span></span>
                        `;
                    }
                } else if (response.status === 403) {
                    displayErrorMessage(
                        "book-rating",
                        generatePermissionErrorMessage(userRole, "view", "book average rating")
                    );
                } else {
                    throw new Error("Failed to fetch book rating.");
                }
            } catch (error) {
                console.error("Error fetching book rating:", error);
                displayErrorMessage("book-rating", error.message);
            }
        }

        function calculateAverageRating(ratingsData) {
            if (ratingsData.length === 0) return 0;
            const totalRating = ratingsData.reduce((sum, rating) => sum + rating.rating, 0);
            return Math.round((totalRating / ratingsData.length) * 100) / 100;
        }

        initEventListeners();
        fetchAndRenderBookDetails();
        fetchAndRenderBookReviews();
        fetchAndRenderBookRating();
        
    });
</script>
{% endblock %}
