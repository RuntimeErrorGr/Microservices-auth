{% extends "base_layout.html" %}

{% block title %}
Book Details - {{ isbn }}
{% endblock %}

{% block content %}
<div>
    <h1 id="book-title" class="text-2xl font-bold text-center mb-4">{{ title }}</h1>
    <div id="book-rating" class="text-center text-sm mb-4">
    </div>
    
    <div class="container mx-auto">
        <!-- Book Details Section -->
        <h3 class="text-xl font-semibold mb-4">Details</h3>
        <div id="book-details-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg mb-6">
                <thead>
                    <tr>
                        <th class="px-6 py-4 border-b text-center">Author</th>
                        <th class="px-6 py-4 border-b text-center">Genre</th>
                        <th class="px-6 py-4 border-b text-center">Publication Date</th>
                        <th class="px-6 py-4 border-b text-center">ISBN</th>
                    </tr>
                </thead>
                <tbody id="book-details">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Book Description Section -->
        <h3 class="text-xl font-semibold mb-4">Description</h3>
        <div id="book-description-section">
            <div id="book-description" class="mb-8 bg-white border border-gray-200 shadow-md rounded-lg px-6 py-10">
                Loading...
            </div>
        </div>

        <!-- Reviews Section -->
        <h3 class="text-xl font-semibold mb-4">Reviews</h3>
        <div id="reviews-section">
            <table class="min-w-full bg-white border border-gray-200 shadow-md rounded-lg">
                <thead>
                    <tr>
                        <th class="px-6 py-3 border-b text-center">Reviewer</th>
                        <th class="px-6 py-3 border-b text-center">Review</th>
                        <th class="px-6 py-3 border-b text-center">Reviewed at</th>
                    </tr>
                </thead>
                <tbody id="reviews-table-body">
                    <tr>
                        <td colspan="3" class="px-6 py-4 text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", async function () {
        const isbn = "{{ isbn }}";
        const userRole = "{{ role }}";
        const rating = parseFloat("{{ rating }}");

        // Fetch and render book details
        async function fetchAndRenderBookDetails() {
            try {
                const response = await fetch(`/books/${isbn}/details`);
                if (response.ok) {
                    const book = await response.json();
                    document.getElementById("book-details").innerHTML = `
                        <tr>
                            <td class="px-6 py-4 border-b text-center">${book.author}</td>
                            <td class="px-6 py-4 border-b text-center">${book.genre}</td>
                            <td class="px-6 py-4 border-b text-center">${book.publicationDate}</td>
                            <td class="px-6 py-4 border-b text-center">${book.isbn}</td>
                        </tr>
                    `;
                    document.getElementById("book-description").textContent = book.description;
                } else if (response.status === 403) {
                    displayErrorMessageWithWhiteBorder(
                        "book-details-section",
                        generatePermissionErrorMessage(userRole, "view", "book details")
                    );
                    displayErrorMessageWithWhiteBorder(
                        "book-description-section",
                        generatePermissionErrorMessage(userRole, "view", "book description")
                    );
                } else {
                    throw new Error("Failed to fetch book details.");
                }
            } catch (error) {
                console.error("Error fetching book details:", error);
                displayErrorMessage("book-details-section", error.message);
                displayErrorMessage("book-description-section", error.message);
            }
        }

        // Fetch and render book reviews
        async function fetchAndRenderBookReviews() {
            try {
                const response = await fetch(`/books/${isbn}/reviews`);
                if (response.ok) {
                    const reviews = await response.json();
                    const reviewsTableBody = document.getElementById("reviews-table-body");
                    reviewsTableBody.innerHTML = "";
                    reviews.forEach(review => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td class="px-6 py-4 border-b text-center">${review.reviewer}</td>
                            <td class="px-6 py-4 border-b text-center">${review.text}</td>
                            <td class="px-6 py-4 border-b text-center">${review.date}</td>
                        `;
                        reviewsTableBody.appendChild(row);
                    });
                } else if (response.status === 403) {
                    displayErrorMessageWithWhiteBorder(
                        "reviews-section",
                        generatePermissionErrorMessage(userRole, "view", "book reviews")
                    );
                } else {
                    throw new Error("Failed to fetch reviews.");
                }
            } catch (error) {
                console.error("Error fetching reviews:", error);
                displayErrorMessage("reviews-section", error.message);
            }
        }

        async function fetchAndRenderBookRating() {
            try {
                const response = await fetch(`/books/${isbn}/ratings`);
                if (response.ok) {
                    const rating = await response.json();
                    const ratingElement = document.getElementById("book-rating");
                    const averageRating = calculateAverageRating(ratingsData);
                    if (averageRating < 0) {
                        displayErrorMessage(
                            "book-rating",
                            generatePermissionErrorMessage(userRole, "view", "book average rating")
                        );
                    } else {
                        const fullStars = Math.floor(averageRating);
                        const halfStar = averageRating - fullStars >= 0.5 ? 1 : 0;
                        const emptyStars = 5 - fullStars - halfStar;

                        ratingElement.innerHTML = `
                            ${'<span class="text-yellow-500">&#9733;</span>'.repeat(fullStars)}
                            ${halfStar ? '<span class="text-yellow-500">&#9734;</span>' : ''}
                            ${'<span class="text-gray-400">&#9734;</span>'.repeat(emptyStars)}
                        `;
                    }
                } else if (response.status === 403) {
                    displayErrorMessage(
                        "book-rating",
                        generatePermissionErrorMessage(userRole, "view", "book average rating")
                    );
                } else {
                    throw new Error("Failed to fetch book rating.");
                }
            } catch (error) {
                console.error("Error fetching book rating:", error);
                displayErrorMessage("book-rating", error.message);
            }
        }

        function calculateAverageRating(ratingsData) {
            if (ratingsData.length === 0) return 0;
            const totalRating = ratingsData.reduce((sum, rating) => sum + rating.rating, 0);
            return Math.round((totalRating / ratingsData.length) * 100) / 100;
        }

        fetchAndRenderBookDetails();
        fetchAndRenderBookReviews();
        fetchAndRenderBookRating();
        
    });
</script>
{% endblock %}
