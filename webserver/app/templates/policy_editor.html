{% extends "base_layout.html" %}

{% block content %}
<div id="policy-editor-root"></div>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">Istio level â†’ change the role - permissions mapping</h1>
    
    <!-- Books Permissions Section -->
    <div class="mb-8">
        <div class="text-lg font-semibold mb-4">permissions for BOOKS</div>
        <div class="bg-white rounded-lg shadow p-6">
            <table class="w-full mb-4">
                <thead>
                    <tr>
                        <th class="text-left w-1/4"></th>
                        <th class="text-center">view</th>
                        <th class="text-center">add</th>
                        <th class="text-center">delete</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="py-2">user</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="user" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="user" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="user" data-permission="delete"></td>
                    </tr>
                    <tr>
                        <td class="py-2">user verified</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="verified" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="verified" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="verified" data-permission="delete"></td>
                    </tr>
                    <tr>
                        <td class="py-2">user verified moderator</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="moderator" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="moderator" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="books" data-role="moderator" data-permission="delete"></td>
                    </tr>
                </tbody>
            </table>
            <button id="saveBooks" class="w-full bg-purple-200 hover:bg-purple-300 text-gray-800 font-semibold py-2 px-4 rounded">
                Save
            </button>
        </div>
    </div>

    <!-- Reviews Permissions Section -->
    <div class="mb-8">
        <div class="text-lg font-semibold mb-4">permissions for REVIEWS</div>
        <div class="bg-white rounded-lg shadow p-6">
            <table class="w-full mb-4">
                <thead>
                    <tr>
                        <th class="text-left w-1/4"></th>
                        <th class="text-center">view</th>
                        <th class="text-center">add</th>
                        <th class="text-center">delete</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="py-2">user</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="user" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="user" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="user" data-permission="delete"></td>
                    </tr>
                    <tr>
                        <td class="py-2">user verified</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="verified" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="verified" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="verified" data-permission="delete"></td>
                    </tr>
                    <tr>
                        <td class="py-2">user verified moderator</td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="moderator" data-permission="view"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="moderator" data-permission="add"></td>
                        <td class="text-center"><input type="checkbox" class="h-5 w-5 bg-purple-200" data-resource="reviews" data-role="moderator" data-permission="delete"></td>
                    </tr>
                </tbody>
            </table>
            <button id="saveReviews" class="w-full bg-purple-200 hover:bg-purple-300 text-gray-800 font-semibold py-2 px-4 rounded">
                Save
            </button>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function() {
    // Add debugging logs
    function loadCurrentPermissions() {
        console.log('Loading permissions...');
        fetch('/api/permissions')
            .then(response => response.json())
            .then(data => {
                console.log('Received permissions:', data);
                if (data.books_permissions) updateCheckboxes('books', data.books_permissions);
                if (data.reviews_permissions) updateCheckboxes('reviews', data.reviews_permissions);
            })
            .catch(error => {
                console.error('Error loading permissions:', error);
                alert('Error loading permissions: ' + error.message);
            });
    }

    function updateCheckboxes(resource, permissions) {
        console.log(`Updating ${resource} checkboxes:`, permissions);
        permissions.forEach(permission => {
            const checkbox = document.querySelector(
                `input[data-resource="${resource}"][data-role="${permission.role}"][data-permission="${permission.permission}"]`
            );
            if (checkbox) {
                checkbox.checked = permission.granted;
                console.log(`Set ${resource} ${permission.role} ${permission.permission} to ${permission.granted}`);
            }
        });
    }

    function savePermissions(resource) {
        console.log(`Saving ${resource} permissions...`);
        const checkboxes = document.querySelectorAll(`input[data-resource="${resource}"]`);
        const permissions = Array.from(checkboxes).map(checkbox => ({
            role: checkbox.dataset.role,
            permission: checkbox.dataset.permission,
            granted: checkbox.checked
        }));

        console.log(`Sending permissions for ${resource}:`, permissions);

        fetch(`/api/permissions/${resource}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ permissions })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`${resource} permissions updated successfully`);
                alert(`${resource} permissions updated successfully`);
            } else {
                console.error(`Error updating ${resource} permissions:`, data.error);
                alert(`Error updating ${resource} permissions: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`Error saving permissions: ${error.message}`);
        });
    }

    // Add click handlers
    document.getElementById('saveBooks').addEventListener('click', () => savePermissions('books'));
    document.getElementById('saveReviews').addEventListener('click', () => savePermissions('reviews'));

    // Load permissions when page loads
    loadCurrentPermissions();
});
</script>
{% endblock %}